#!/usr/bin/env node

const
  parseArgs = require('minimist'),
  path = require('path'),
  chalk = require('chalk')

const
  log = require('../lib/helpers/logger')('app:dev')
  appPaths = require('../lib/build/app-paths'),
  resolve = path.resolve

const argv = parseArgs(process.argv.slice(2), {
  alias: {
    t: 'theme',
    m: 'mode',
    T: 'target',
    p: 'port',
    H: 'hostname',
    h: 'help'
  },
  boolean: ['h'],
  string: ['t', 'm', 'T', 'H'],
  default: {
    t: 'mat',
    m: 'spa',
    p: process.env.PORT || 8080,
    H: 'localhost'
  }
})

if (argv.help) {
  console.log(`
    Description
      Starts the app in development mode (hot-code reloading, error
      reporting, etc)
    Usage
      $ npm run qapp dev -- -p <port number>
    Options
      --theme, -t         App theme (default: mat)
      --mode, -m          App mode [spa|pwa|cordova|electron] (default: spa)
      --target, -T        App target [if cordova mode: android|ios|blackberry10|browser|osx|ubuntu|webos|windows; if electron: darwin|win32|linux|mas|all]
      --port, -p          A port number on which to start the application
      --hostname, -H      A hostname to use for serving the application
      --help, -h          Displays this message
  `)
  process.exit(0)
}

require('../lib/helpers/ensure-argv')(argv, 'dev')
if (argv.mode !== 'spa') {
  require('../lib/mode/install-missing')(argv.mode)
}

log(`Mode [ ${chalk.red(argv.mode.toUpperCase())} ] with [ ${chalk.red(argv.theme.toUpperCase())} ] theme`)

const
  DevServer = require('../lib/dev-server'),
  QuasarConfig = require('../lib/quasar-config'),
  Generator = require('../lib/generator')

const
  quasarConfig = new QuasarConfig({
    theme: argv.theme,
    mode: argv.mode,
    target: argv.target,
    port: argv.port,
    host: argv.hostname,
    dev: true,
    onBuildChange () {
      log(`Rebuilding app...`)
      dev = dev.then(startDev)
    },
    onAppChange () {
      log(`Updating app...`)
      generator.build()
    }
  }),
  generator = new Generator(quasarConfig)

function startDev (oldDevServer) {
  const devServer = new DevServer(quasarConfig)

  return Promise.resolve()
    .then(() => Cordova ? Cordova.stop() : Promise.resolve())
    .then(() => Electron ? Electron.stop() : Promise.resolve())
    .then(() => oldDevServer ? oldDevServer.stop() : Promise.resolve()) // Close old builder after successful build
    .then(() => generator.build()) // Update generated files
    .then(() => devServer.listen()) // Start listening
    .then(() => Cordova ? Cordova.run(quasarConfig) : Promise.resolve())
    .then(() => Electron ? Electron.run(quasarConfig) : Promise.resolve())
    .then(() => devServer) // Pass new builder to watch chain
}

const
  Cordova = argv.mode === 'cordova' ? require('../lib/cordova') : false,
  Electron = argv.mode === 'electron' ? require('../lib/electron') : false

let dev = startDev()
